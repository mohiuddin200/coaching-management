/**
 * Debug script for student soft delete issue
 * Run this script to test the soft delete functionality and identify issues
 */

// This script can be run with: node debug-student-deletion.js

const TEST_STUDENT_ID = process.argv[2]; // Pass student ID as argument

if (!TEST_STUDENT_ID) {
  console.log('Usage: node debug-student-deletion.js <student-id>');
  console.log('Example: node debug-student-deletion.js 123e4567-e89b-12d3-a456-426614174000');
  process.exit(1);
}

console.log(`üîç Debugging student deletion for ID: ${TEST_STUDENT_ID}`);
console.log('='.repeat(50));

async function debugStudentDeletion() {
  try {
    // Step 1: Check debug endpoint
    console.log('\nüìä Step 1: Analyzing student data...');
    const debugResponse = await fetch(`http://localhost:3000/api/students/${TEST_STUDENT_ID}/debug`);
    
    if (!debugResponse.ok) {
      const error = await debugResponse.json();
      console.error('‚ùå Debug endpoint failed:', error);
      return;
    }
    
    const debugData = await debugResponse.json();
    console.log('‚úÖ Debug analysis:');
    console.log(`   Student: ${debugData.student.name} (${debugData.student.email})`);
    console.log(`   Level: ${debugData.student.level}`);
    console.log(`   Is Deleted: ${debugData.student.isDeleted}`);
    console.log(`   Related Records:`, debugData.relatedRecords);
    console.log(`   Auto-Generated Enrollments: ${debugData.enrollmentAnalysis.filter(e => e.isAutoGenerated).length}`);
    console.log(`   Manual Enrollments: ${debugData.enrollmentAnalysis.filter(e => !e.isAutoGenerated).length}`);
    
    // Step 2: Test cleanup function
    console.log('\nüßπ Step 2: Testing cleanup function...');
    console.log(`   Cleanup Result:`, debugData.cleanupResult);
    
    // Step 3: Check remaining enrollments
    console.log('\nüìã Step 3: Checking remaining enrollments...');
    console.log(`   Remaining Enrollments: ${debugData.remainingEnrollmentsCount}`);
    if (debugData.remainingEnrollments.length > 0) {
      console.log('   Remaining Details:');
      debugData.remainingEnrollments.forEach(e => {
        console.log(`     - ${e.classSectionName} (${e.isAutoGenerated ? 'Auto-generated' : 'Manual'})`);
      });
    }
    
    // Step 4: Attempt actual soft delete
    console.log('\nüóëÔ∏è  Step 4: Attempting soft delete...');
    const deleteResponse = await fetch(`http://localhost:3000/api/students/${TEST_STUDENT_ID}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    const deleteResult = await deleteResponse.json();
    
    if (deleteResponse.ok) {
      console.log('‚úÖ Soft delete successful!');
      console.log('   Response:', deleteResult);
    } else {
      console.log('‚ùå Soft delete failed!');
      console.log('   Status:', deleteResponse.status);
      console.log('   Error:', deleteResult);
      
      // Analyze the failure
      if (deleteResult.error && deleteResult.error.includes('related records')) {
        console.log('\nüîç Analysis: Failed due to related records');
        console.log('   This suggests there are still blocking records after cleanup.');
        console.log('   Check the enrollment details above to identify manual enrollments.');
      } else if (deleteResult.error && deleteResult.error.includes('cleanup')) {
        console.log('\nüîç Analysis: Failed during cleanup phase');
        console.log('   The cleanup function encountered an error.');
        console.log('   Check server logs for detailed error information.');
      } else {
        console.log('\nüîç Analysis: Unknown error occurred');
        console.log('   Check server logs for detailed error information.');
      }
    }
    
    // Step 5: Verify final state
    console.log('\nüîç Step 5: Verifying final state...');
    const finalDebugResponse = await fetch(`http://localhost:3000/api/students/${TEST_STUDENT_ID}/debug`);
    
    if (finalDebugResponse.ok) {
      const finalDebugData = await finalDebugResponse.json();
      console.log(`   Final Is Deleted: ${finalDebugData.student.isDeleted}`);
      console.log(`   Final Enrollments: ${finalDebugData.remainingEnrollmentsCount}`);
    }
    
  } catch (error) {
    console.error('\nüí• Debug script failed:', error);
    console.log('   Make sure the development server is running on localhost:3000');
    console.log('   Check that the student ID is valid');
  }
}

// Run the debug function
debugStudentDeletion();