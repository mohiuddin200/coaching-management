generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String             @id @default(uuid())
  email          String             @unique
  role           UserRole           @default(Teacher) // DEPRECATED (keep for transition)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  teacherProfile Teacher?           @relation("UserToTeacher")
  organizations  UserOrganization[] // NEW

  @@map("users")
}

// New Organization Model
model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  email       String?
  phone       String?
  address     String?
  logo        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users           UserOrganization[]
  teachers        Teacher[]
  students        Student[]
  levels          Level[]
  classSections   ClassSection[]
  exams           Exam[]
  feeStructures   FeeStructure[]
  studentPayments StudentPayment[]
  teacherPayments TeacherPayment[]
  expenses        Expense[]

  @@map("organizations")
}

// New UserOrganization Junction Table
model UserOrganization {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           SystemRole   @default(AcademicCoordinator)
  canInvite      Boolean      @default(false)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@map("user_organizations")
}

model Teacher {
  id                       String           @id @default(uuid())
  firstName                String
  lastName                 String
  email                    String?
  phoneNumber              String
  subject                  String?
  qualifications           String?
  joinDate                 DateTime         @default(now())
  status                   Status           @default(Active)
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  userId                   String?          @unique
  organizationId           String           // NEW
  bloodGroup               BloodGroup?
  cgpa                     Float?
  city                     String?
  country                  String?
  cv                       String?
  dateOfBirth              DateTime?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  gender                   Gender?
  idProof                  String?
  nationality              String?
  nid                      String?          @unique
  paymentType              PaymentType?
  postalCode               String?
  profileImage             String?
  religion                 String?
  salary                   Float?
  state                    String?
  streetAddress            String?
  universityName           String?
  // Family Information
  fatherName               String?          @map("father_name")
  motherName               String?          @map("mother_name")
  // Address Information
  presentAddress           String?          @map("present_address")
  permanentAddress         String?          @map("permanent_address")
  // Educational & Professional Background
  previousInstitute        String?          @map("previous_institute")
  experience               Float?           @default(0) @map("experience")
  passedSchool             String?          @map("passed_school")
  passedCollege            String?          @map("passed_college")
  reference                String?
  // Image URLs
  nidImageUrl              String?          @map("nid_image_url")
  teacherPhotoUrl          String?          @map("teacher_photo_url")
  universityIdCardUrl      String?          @map("university_id_card_url")
  // Social Media Links
  facebookLink             String?          @map("facebook_link")
  instagramLink            String?          @map("instagram_link")
  linkedinLink             String?          @map("linkedin_link")
  // Soft Delete
  isDeleted                Boolean          @default(false) @map("is_deleted")
  deletedAt                DateTime?        @map("deleted_at")
  deletedBy                String?          @map("deleted_by")
  deleteReason             DeleteReason?    @map("delete_reason")
  classSections            ClassSection[]   @relation("TeacherToClassSection")
  payments                 TeacherPayment[]
  exams                    Exam[]
  user                     User?            @relation("UserToTeacher", fields: [userId], references: [id])
  organization             Organization     @relation(fields: [organizationId], references: [id]) // NEW

  @@map("teachers")
}

model Student {
  id                       String           @id @default(uuid())
  firstName                String
  lastName                 String
  email                    String
  phoneNumber              String
  studentPhoneNumber       String?
  whatsappNumbers          String[]         @default([])
  dateOfBirth              DateTime
  monthlyFee               Float?
  address                  String
  enrollmentDate           DateTime         @default(now())
  status                   Status           @default(Active)
  smsEnabled               Boolean          @default(false)
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  levelId                  String
  organizationId           String           // NEW
  birthCertificate         String?
  bloodGroup               BloodGroup?
  city                     String?
  country                  String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  fatherName               String
  fatherPhone              String
  gender                   Gender?
  idProof                  String?
  motherName               String
  motherPhone              String
  nationality              String?
  postalCode               String?
  previousClass            String?
  previousMarks            Float?
  previousSchool           String?
  profileImage             String?
  religion                 String?
  state                    String?
  streetAddress            String?
  isDeleted                Boolean          @default(false) @map("is_deleted")
  deletedAt                DateTime?        @map("deleted_at")
  deletedBy                String?          @map("deleted_by")
  deleteReason             DeleteReason?    @map("delete_reason")
  attendances              Attendance[]
  enrollments              Enrollment[]
  payments                 StudentPayment[]
  examResults              ExamResult[]
  level                    Level            @relation(fields: [levelId], references: [id])
  organization             Organization     @relation(fields: [organizationId], references: [id]) // NEW

  @@map("students")
}

model Level {
  id            String         @id @default(cuid())
  name          String         @unique
  levelNumber   Int            @unique
  description   String?
  status        Status         @default(Active)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  organizationId String        // NEW
  students      Student[]
  subjects      Subject[]
  feeStructures FeeStructure[]
  exams         Exam[]
  organization  Organization   @relation(fields: [organizationId], references: [id]) // NEW

  @@map("levels")
}

model Subject {
  id            String         @id @default(cuid())
  name          String
  code          String?
  description   String?
  levelId       String
  status        Status         @default(Active)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  classSections ClassSection[]
  exams         Exam[]
  level         Level          @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@unique([levelId, name])
  @@map("subjects")
}

model ClassSection {
  id             String       @id @default(cuid())
  name           String
  subjectId      String
  teacherId      String
  capacity       Int          @default(30)
  roomNumber     String?
  academicYear   String
  status         ClassStatus  @default(Scheduled)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String       // NEW
  attendances    Attendance[]
  subject        Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher        Teacher      @relation("TeacherToClassSection", fields: [teacherId], references: [id])
  enrollments    Enrollment[]
  schedules      Schedule[]
  organization   Organization @relation(fields: [organizationId], references: [id]) // NEW

  @@map("class_sections")
}

model Schedule {
  id             String       @id @default(cuid())
  classSectionId String
  dayOfWeek      DayOfWeek
  startTime      String
  endTime        String
  status         Status       @default(Active)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  classSection   ClassSection @relation(fields: [classSectionId], references: [id], onDelete: Cascade)

  @@map("schedules")
}

model Enrollment {
  id             String           @id @default(cuid())
  enrollmentDate DateTime         @default(now())
  status         EnrollmentStatus @default(Active)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  studentId      String
  classSectionId String?
  classSection   ClassSection?    @relation(fields: [classSectionId], references: [id], onDelete: Cascade)
  student        Student          @relation(fields: [studentId], references: [id])

  @@map("enrollments")
}

model Attendance {
  id             String           @id @default(cuid())
  date           DateTime         @db.Date
  status         AttendanceStatus
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  studentId      String
  classSectionId String?
  deviceId       String?
  classSection   ClassSection?    @relation(fields: [classSectionId], references: [id], onDelete: Cascade)
  device         BiometricDevice? @relation(fields: [deviceId], references: [id])
  student        Student          @relation(fields: [studentId], references: [id])

  @@unique([studentId, date])
  @@map("attendances")
}

model BiometricDevice {
  id          String       @id @default(cuid())
  name        String
  apiEndpoint String
  apiKey      String?
  status      String       @default("active")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  attendances Attendance[]

  @@map("biometric_devices")
}

model SmsLog {
  id             String    @id @default(cuid())
  recipientPhone String
  messageContent String
  status         SmsStatus @default(Pending)
  cost           Float?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("sms_logs")
}

model MarketingContact {
  id            String    @id @default(cuid())
  parentName    String
  phoneNumber   String    @unique
  queryDetails  String?
  lastContacted DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("marketing_contacts")
}

model Feedback {
  id        String         @id @default(cuid())
  userId    String?
  userName  String?
  email     String?
  type      FeedbackType   @default(General)
  subject   String
  message   String
  status    FeedbackStatus @default(Open)
  priority  Priority       @default(Medium)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@map("feedbacks")
}

model FeeStructure {
  id             String       @id @default(cuid())
  name           String
  levelId        String?
  amount         Float
  frequency      FeeFrequency @default(Monthly)
  academicYear   String
  description    String?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String       // NEW
  level          Level?       @relation(fields: [levelId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id]) // NEW

  @@map("fee_structures")
}

model StudentPayment {
  id             String        @id @default(cuid())
  studentId      String
  amount         Float
  paymentDate    DateTime
  dueDate        DateTime
  status         PaymentStatus @default(Pending)
  monthYear      String
  description    String?
  receiptNo      String?
  isDeleted      Boolean       @default(false) @map("is_deleted")
  deletedAt      DateTime?     @map("deleted_at")
  deletedBy      String?       @map("deleted_by")
  deleteReason   DeleteReason? @map("delete_reason")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String        // NEW
  student        Student       @relation(fields: [studentId], references: [id])
  organization   Organization  @relation(fields: [organizationId], references: [id]) // NEW

  @@index([isDeleted])
  @@index([deletedAt])
  @@map("student_payments")
}

model TeacherPayment {
  id             String        @id @default(cuid())
  teacherId      String
  amount         Float
  paymentDate    DateTime
  periodStart    DateTime
  periodEnd      DateTime
  status         PaymentStatus @default(Paid)
  description    String?
  receiptNo      String?
  isDeleted      Boolean       @default(false) @map("is_deleted")
  deletedAt      DateTime?     @map("deleted_at")
  deletedBy      String?       @map("deleted_by")
  deleteReason   DeleteReason? @map("delete_reason")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String        // NEW
  teacher        Teacher       @relation(fields: [teacherId], references: [id])
  organization   Organization  @relation(fields: [organizationId], references: [id]) // NEW

  @@index([isDeleted])
  @@index([deletedAt])
  @@map("teacher_payments")
}

model Expense {
  id             String          @id @default(cuid())
  category       ExpenseCategory
  amount         Float
  expenseDate    DateTime
  description    String
  vendor         String?
  receiptNo      String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organizationId String          // NEW
  organization   Organization    @relation(fields: [organizationId], references: [id]) // NEW

  @@map("expenses")
}

model Exam {
  id               String         @id @default(cuid())
  name             String
  type             ExamType       @default(Monthly)
  description      String?
  subjectId        String
  subject          Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  levelId          String
  level            Level          @relation(fields: [levelId], references: [id], onDelete: Cascade)
  teacherId        String
  teacher          Teacher        @relation(fields: [teacherId], references: [id])
  totalMarks       Float
  passingMarks     Float?
  examDate         DateTime
  duration         Int?
  questionPaperUrl String?
  answerKeyUrl     String?
  startTime        String?
  endTime          String?
  roomNumber       String?
  academicYear     String
  status           ExamStatus     @default(Scheduled)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  createdBy        String?
  isDeleted        Boolean        @default(false) @map("is_deleted")
  deletedAt        DateTime?      @map("deleted_at")
  deletedBy        String?        @map("deleted_by")
  deleteReason     DeleteReason?  @map("delete_reason")
  organizationId   String         // NEW
  results          ExamResult[]
  notifications    Notification[]
  organization     Organization   @relation(fields: [organizationId], references: [id]) // NEW

  @@index([isDeleted])
  @@index([deletedAt])
  @@index([examDate])
  @@index([subjectId])
  @@index([levelId])
  @@map("exams")
}

model ExamResult {
  id            String    @id @default(cuid())
  examId        String
  exam          Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentId     String
  student       Student   @relation(fields: [studentId], references: [id])
  marksObtained Float?
  grade         String?
  remarks       String?
  attended      Boolean   @default(false)
  absentReason  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  gradedBy      String?
  gradedAt      DateTime?

  @@unique([examId, studentId])
  @@index([studentId])
  @@index([examId])
  @@map("exam_results")
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  userId    String?
  examId    String?
  exam      Exam?            @relation(fields: [examId], references: [id], onDelete: Cascade)
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// New SystemRole Enum
enum SystemRole {
  SuperAdmin
  OrganizationAdmin
  FinanceManager
  AcademicCoordinator
}

enum ExamType {
  Monthly
  Weekly
  OpenBook
  Midterm
  Final
  Quiz
  Assignment
}

enum ExamStatus {
  Scheduled
  InProgress
  Completed
  Cancelled
  Postponed
}

enum NotificationType {
  ExamScheduled
  ExamReminder
  ResultPublished
  ExamCancelled
  ExamPostponed
  System
}

enum Gender {
  Male
  Female
  Other
}

enum BloodGroup {
  A_Positive
  A_Negative
  B_Positive
  B_Negative
  AB_Positive
  AB_Negative
  O_Positive
  O_Negative
}

enum UserRole {
  Admin
  Teacher
  Staff
}

enum Status {
  Active
  Inactive
}

enum ClassStatus {
  Scheduled
  InProgress
  Completed
  Cancelled
}

enum EnrollmentStatus {
  Active
  Withdrawn
  Completed
}

enum SmsStatus {
  Sent
  Failed
  Pending
}

enum DayOfWeek {
  Monday
  Tuesday
  Wednesday
  Thursday
  Friday
  Saturday
  Sunday
}

enum FeedbackType {
  General
  BugReport
  FeatureRequest
  Support
  Complaint
  Suggestion
}

enum FeedbackStatus {
  Open
  InProgress
  Resolved
  Closed
}

enum Priority {
  Low
  Medium
  High
  Urgent
}

enum PaymentType {
  SALARIED
  HOURLY
  PER_CLASS
}

enum AttendanceStatus {
  Present
  Absent
}

enum PaymentStatus {
  Pending
  Paid
  Overdue
  Cancelled
}

enum FeeFrequency {
  Monthly
  Quarterly
  Yearly
  OneTime
}

enum ExpenseCategory {
  Salary
  Rent
  Utilities
  SMS
  Marketing
  Supplies
  Maintenance
  Equipment
  Other
}

enum DeleteReason {
  RESIGNED
  TERMINATED
  REASSIGNED
  GRADUATED
  TRANSFERRED
  ERROR
  OTHER
  DUPLICATE
  REFUND
  CANCELLED
  WRONG_ENTRY
}
